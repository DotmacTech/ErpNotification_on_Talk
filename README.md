ERPNext-Nextcloud Talk IntegrationThis Flask application acts as a middleware to connect ERPNext and Nextcloud Talk. It listens for webhook events from ERPNext (specifically, when a task or ticket is assigned to a user) and sends a notification to the assigned user in Nextcloud Talk.FeaturesERPNext Webhook Listener: Receives webhook notifications from ERPNext when a new assignment occurs.User Details Retrieval: Fetches the user's full name from ERPNext using the provided email.Nextcloud Talk Notification: Sends a formatted message to the user in Nextcloud Talk, including a link to the assigned document in ERPNext.Duplicate Webhook Prevention: Stores processed webhook payloads in a database to prevent duplicate notifications.Error Handling and Retries: Includes error logging and a retry mechanism with exponential backoff for Nextcloud Talk API requests.Database Storage: Uses SQLite to persist user data and processed webhook information.PM2 Support: Instructions to run the application with PM2 for process management and automatic restarts.PrerequisitesPython 3.6 or laterERPNext instanceNextcloud instance with Nextcloud Talk enabledpip (Python package installer)PM2 (Process Manager 2)InstallationClone the repository:git clone <repository_url>
cd erpnext-nextcloud-talk
Create a virtual environment (recommended):python3 -m venv venv
source venv/bin/activate  # On Linux/macOS
venv\Scripts\activate  # On Windows
Install dependencies:pip install -r requirements.txt
Set up environment variables:Create a .env file in the project root directory.Copy the contents of .env.example into .env and modify the values to match your ERPNext and Nextcloud instances.Initialize the database:This should happen automatically on first run, but you can manually initialize it by running the Flask application.Run the Flask application with PM2 (for persistence):To start the application with PM2, open a terminal in the directory containing your main.py file (which, based on your file structure, is ~/erpnext_talk_middleware/app). Then, run the following commands:cd ~/erpnext_talk_middleware/app
pm2 start main.py --name "erpnext-talk-middleware"
pm2 save
The pm2 start command launches your Flask application and assigns it the name "erpnext-talk-middleware".  The --name option is useful for managing multiple applications with PM2.The pm2 save command tells PM2 to remember the applications it is managing.  This is crucial for ensuring that your application restarts automatically whenever the server restarts.  Without this command, PM2 will not automatically restart your application.ConfigurationYou need to configure the following environment variables in a .env file:ERPNEXT_API_URL: The URL of your ERPNext instance (e.g., https://your_erpnext_instance).ERPNEXT_API_KEY: The API Key for a user in ERPNext with appropriate permissions.ERPNEXT_API_SECRET: The API Secret for the same user.NEXTCLOUD_API_URL: The URL of your Nextcloud instance (e.g., https://your_nextcloud_instance).NEXTCLOUD_USERNAME: The username of the Nextcloud user the application will use to connect to the Nextcloud API.NEXTCLOUD_APP_PASSWORD: The application password generated in Nextcloud for the specified user.TALK_BOT_USERNAME (Optional): The name the bot will use in Nextcloud Talk (defaults to "ERPNext").ERPNext SetupCreate a Webhook in ERPNext:Go to the doctype for which you want to create notifications (e.g., "ToDo", "Help Desk Ticket").Create a new Webhook.Set the "Event" to "After Submit" or the appropriate event.In the "Request URL" field, enter the URL of your Flask application (e.g., http://your_server:5001/webhook).In the "Data" section, include the following fields:allocated_to: The email address of the user the task is assigned to.reference_type: The type of document (e.g., "ToDo", "Help Desk Ticket").reference_name: The name or ID of the document.assigned_by_full_name: The full name of the user who assigned the task.due_date: The due date of the task or ticket.Save the Webhook.Nextcloud SetupCreate an Application Password:Log in to your Nextcloud instance as the user you want the Flask application to use.Go to "Settings" -> "Security".Under "App passwords", create a new app password with a descriptive name (e.g., "ERPNext Integration").Copy the generated password. This is the NEXTCLOUD_APP_PASSWORD you'll use in the .env file.Ensure that the Nextcloud user has the necessary permissions to create direct conversations and send messages.UsageOnce the application is running and the webhook is configured in ERPNext, notifications will be sent to Nextcloud Talk whenever the specified event occurs in ERPNext. Using PM2 ensures that the application restarts automatically if the server is restarted.
